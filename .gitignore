#include <WiFi.h>
#include <WebSocketsClient.h>

// Informasi WiFi
const char* ssid = "iphone";
const char* password = "12345678";

// URL WebSocket server yang di-host di Vercel
const char* webSocketServer = "my-project-pr8rig78i-muhammad-novians-projects.vercel.app/api/websocket";

// Inisialisasi WebSocketClient
WebSocketsClient webSocket;

void webSocketEvent(WStype_t type, uint8_t * payload, size_t length) {
  switch (type) {
    case WStype_DISCONNECTED:
      Serial.println("WebSocket disconnected");
      break;
    case WStype_CONNECTED:
      Serial.println("WebSocket connected");
      webSocket.sendTXT("ESP32 Connected");
      break;
    case WStype_TEXT:
      Serial.printf("Message received: %s\n", payload);
      break;
  }
}

void setup() {
  Serial.begin(115200);

  // Menghubungkan ESP32 ke WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("\nConnected to WiFi");

  // Menghubungkan ke server WebSocket (Vercel)
  webSocket.beginSSL(webSocketServer, 443, "/api/websocket");
  webSocket.onEvent(webSocketEvent);
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    webSocket.loop();  // Memproses event WebSocket
  } else {
    Serial.println("WiFi disconnected, reconnecting...");
    WiFi.reconnect();  // Mencoba menghubungkan kembali ke WiFi
  }

  // Mengirim data ke WebSocket setiap detik
  String message = String("Light: ") + random(100, 1000) + " lx";  // Ganti dengan data sensor
  webSocket.sendTXT(message);
  delay(1000);
}
